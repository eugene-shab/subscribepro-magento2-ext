<?php
/** @var $block \Swarming\SubscribePro\Block\Wallet\Delete */
/** @var $escaper \Magento\Framework\Escaper */
?>
<?php if ($block->isWalletEnabled()): ?>
<?php
$walletWidgetUrl = $block->getWalletWidgetUrl();
$walletWidgetJson = $block->getWalletWidgetJson();
?>
<script src="<?php echo $walletWidgetUrl; ?>"></script>
<script>
require([
    'jquery',
], function($){
    var cardTable = $('#my-orders-table'),
        removeBtnList = cardTable.find('tr form button.action.delete'),
        allowOriginClick = false;

    if (removeBtnList.length) {
        removeBtnList.on('click', function (event) {
            if (allowOriginClick) {
                return true;
            }
            event.preventDefault();
            event.stopImmediatePropagation();

            let self = $(this),
                paymentProfile =  {
                id: self.data('profile-id'),
            };

            WalletAssist.onBeforePaymentProfileDeleted({"paymentProfile": paymentProfile}, function (paymentProfile, shouldDelete) {
                if (shouldDelete === 'delete') {
                    self.closest('form').submit();
                    return true;
                } else if (shouldDelete === "not_found") {
                    allowOriginClick = true;
                    self.click();
                } else {
                    return false;
                }
            });

            return false;
        });

        let baseWidgetConfig = {
            apiAccessToken: "<?php echo $block->getWidgetAccessTokenForCurrentCustomer(); ?>",
            customerId: <?php echo $block->getPlatformCustomerId(); ?>
        };

        let widgetConfig = <?php echo $walletWidgetJson; ?>;
        for (let key in baseWidgetConfig) {
            widgetConfig[key] = baseWidgetConfig[key];
        }

        WalletAssist.init(widgetConfig);
    }
});
</script>
<div id="sp-wallet"></div>
<?php endif; ?>
